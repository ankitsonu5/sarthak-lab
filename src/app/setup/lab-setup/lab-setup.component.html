<div class="lab-setup-container">
  <h1>Lab Setup</h1>
  <p class="muted">Login → Lab Setup → Save & Preview. You can edit/update anytime.</p>
  <div class="subnav">
    <a href="#basic">Basic</a>
    <a href="#branding">Branding</a>
    <a href="#numbering">Numbering</a>
    <a href="#notes">Notes</a>
    <a href="#layout">Layout</a>
    <a href="#preview">Preview</a>
  </div>


  <div class="grid">
    <form (ngSubmit)="saveAndPreview()" [formGroup]="form" class="card">
      <h2 id="basic">Basic Details</h2>
      <div class="row"><label>Lab Name</label><input formControlName="labName" placeholder="ABC Diagnostics" (input)="updatePreview()"/></div>
      <div class="row"><label>Short Name</label><input formControlName="shortName" placeholder="ABC LAB" (input)="updatePreview()"/></div>
      <div class="row"><label>Address Line 1</label><input formControlName="addressLine1" (input)="updatePreview()"/></div>
      <div class="row"><label>Address Line 2</label><input formControlName="addressLine2" (input)="updatePreview()"/></div>
      <div class="row two">
        <div><label>City</label><input formControlName="city" (input)="updatePreview()"/></div>
        <div><label>State</label><input formControlName="state" (input)="updatePreview()"/></div>
      </div>
      <div class="row two">
        <div><label>Pincode</label><input formControlName="pincode" (input)="updatePreview()"/></div>
        <div><label>Phone</label><input formControlName="phone" (input)="updatePreview()"/></div>
      </div>
      <div class="row two">
        <div><label>Alt Phone</label><input formControlName="altPhone" (input)="updatePreview()"/></div>
        <div><label>Email</label><input formControlName="email" (input)="updatePreview()"/></div>
      </div>
      <div class="row"><label>Website</label><input formControlName="website" (input)="updatePreview()"/></div>

      <h2 id="branding">Branding</h2>
      <div class="row two">
        <div>
          <label>Logo (Left)</label>
          <input type="file" accept="image/*" (change)="onFileChange($event, 'logoDataUrl')" />
        </div>
        <div>
          <label>Side Logo (Right)</label>
          <input type="file" accept="image/*" (change)="onFileChange($event, 'sideLogoDataUrl')" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>Authorized Sign</label>
          <input type="file" accept="image/*" (change)="onFileChange($event, 'signatureDataUrl')" />
        </div>
      </div>

      <h2 id="numbering">Print & Numbering</h2>
      <div formGroupName="prefixes">
        <div class="row two">
          <div><label>Receipt Prefix</label><input formControlName="receipt" placeholder="RCPT" (input)="updatePreview()"/></div>
          <div><label>Report Prefix</label><input formControlName="report" placeholder="RPT" (input)="updatePreview()"/></div>
        </div>
        <div class="row two">
          <div><label>Yearly No. Prefix</label><input formControlName="labYearlyPrefix" placeholder="LY" (input)="updatePreview()"/></div>
          <div><label>Daily No. Prefix</label><input formControlName="labDailyPrefix" placeholder="LD" (input)="updatePreview()"/></div>
        </div>
      </div>
      <div formGroupName="numbering">
        <div class="row two">
          <div><label>Receipt Start</label><input type="number" formControlName="receiptStart" (input)="updatePreview()"/></div>
          <div><label>Report Start</label><input type="number" formControlName="reportStart" (input)="updatePreview()"/></div>
        </div>
        <div class="row">
          <label>Reset Rule</label>
          <select formControlName="resetRule" (change)="updatePreview()">
            <option value="yearly">Yearly</option>
            <option value="monthly">Monthly</option>
            <option value="never">Never</option>
          </select>
        </div>
      </div>

      <h2 id="notes">Notes</h2>
      <div class="row"><label>Header Note</label><input formControlName="headerNote" (input)="updatePreview()"/></div>
      <div class="row"><label>Footer Note</label><input formControlName="footerNote" (input)="updatePreview()"/></div>
      <div class="row"><label>Report Disclaimer</label><textarea formControlName="reportDisclaimer" rows="2" (input)="updatePreview()"></textarea></div>

      <h2 id="layout">Layout Options</h2>
      <p class="muted" style="font-size:12px; margin-top:-4px;">To change report template style, go to <a routerLink="/setup/lab-template" style="color:#2563eb;">Lab Template</a> page.</p>
      <div formGroupName="printLayout">
        <div class="row toggles">
          <label class="switch">
            <input type="checkbox" formControlName="showHeader" (change)="updatePreview()"/>
            <span class="slider"></span><span class="switch-text">Show Header</span>
          </label>
          <label class="switch">
            <input type="checkbox" formControlName="showFooter" (change)="updatePreview()"/>
            <span class="slider"></span><span class="switch-text">Show Footer</span>
          </label>
          <label class="switch">
            <input type="checkbox" formControlName="showQr" (change)="updatePreview()"/>
            <span class="slider"></span><span class="switch-text">Show QR</span>
          </label>
        </div>
      </div>

      <div class="actions">
        <button class="btn primary" type="submit" [disabled]="saving">{{ saving ? 'Saving…' : 'Save & Preview' }}</button>
        <div class="status" *ngIf="statusMessage" [class.error]="statusError">{{ statusMessage }}</div>
      </div>

      <!-- Self-Registration Link & QR - INSIDE form, below actions -->
      <div class="self-reg-section" *ngIf="labCode">
        <h2>Public Self-Registration</h2>
        <div class="self-reg-content">
          <div class="self-reg-info">
            <div class="muted">Share this link with patients for self-registration</div>
            <div class="self-reg-link">{{ selfRegLink }}</div>
            <div class="self-reg-buttons">
              <button class="btn" type="button" (click)="copySelfRegLink()">{{ copyDone ? 'Copied!' : 'Copy link' }}</button>
              <button class="btn" type="button" (click)="printSelfRegQR()">Print QR</button>
            </div>
          </div>
          <div class="self-reg-qr">
            <img [src]="selfRegQrUrl" alt="Self-Register QR" width="140" height="140"/>
          </div>
        </div>
      </div>
    </form>

    <div class="card preview" *ngIf="form">
      <h2 id="preview">Preview</h2>
      <div class="report">
        <div class="header" *ngIf="form.get('printLayout.showHeader')?.value !== false">
          <img *ngIf="form.get('logoDataUrl')?.value" class="logo left-logo" [src]="form.get('logoDataUrl')?.value" alt="logo"/>
          <div class="header-mid">
            <div class="title">{{ form.get('labName')?.value || 'Your Lab Name' }}</div>
            <div class="addr">{{ form.get('addressLine1')?.value }} {{ form.get('addressLine2')?.value }} {{ form.get('city')?.value }} {{ form.get('state')?.value }} - {{ form.get('pincode')?.value }}</div>
            <div class="contact">Ph: {{ form.get('phone')?.value }} | {{ form.get('email')?.value }}</div>
            <div class="header-note">{{ form.get('headerNote')?.value }}</div>
          </div>
          <img *ngIf="form.get('sideLogoDataUrl')?.value" class="logo right-logo" [src]="form.get('sideLogoDataUrl')?.value" alt="side logo"/>
        </div>
        <div class="body">
          <div class="placeholder">Sample report area preview…</div>
        </div>
        <div class="footer" *ngIf="form.get('printLayout.showFooter')?.value !== false">
          <div class="footer-note">{{ form.get('footerNote')?.value }}</div>
          <img *ngIf="form.get('signatureDataUrl')?.value" class="sign" [src]="form.get('signatureDataUrl')?.value" alt="sign"/>
          <div class="disclaimer">{{ form.get('reportDisclaimer')?.value }}</div>
        </div>
      </div>
    </div>
  </div>
</div>

