<!-- Professional Diagnostic Report Layout -->
<div class="report-page">

  <!-- Print Controls (hidden in print) -->
  <div class="print-controls no-print">
    <button type="button" class="print-btn" (click)="printReport()">üñ®Ô∏è Print Report</button>
  </div>

  <!-- Main Report Container -->
  <div class="report-container" id="pathology-report-print">

    <!-- Header Section -->
    <header class="report-header" *ngIf="labSettings?.printLayout?.showHeader !== false">
      <div class="header-left">
        <img *ngIf="labSettings?.logoDataUrl" [src]="labSettings?.logoDataUrl" alt="Lab Logo" class="lab-logo">
      </div>
      <div class="header-center">
        <h1 class="lab-name">{{ defaultLabConfig.getLabName(labSettings?.labName) }}</h1>
        <p class="lab-address" *ngIf="labSettings?.addressLine1 || labSettings?.city">
          {{ labSettings?.addressLine1 }}{{ labSettings?.addressLine2 ? ', ' + labSettings?.addressLine2 : '' }}{{ labSettings?.city ? ', ' + labSettings?.city : '' }}{{ labSettings?.state ? ', ' + labSettings?.state : '' }}{{ labSettings?.pincode ? ' - ' + labSettings?.pincode : '' }}
        </p>
        <p class="lab-contact" *ngIf="labSettings?.phone || labSettings?.email">
          {{ labSettings?.phone ? 'Ph: ' + labSettings?.phone : '' }}{{ labSettings?.email ? ' | ' + labSettings?.email : '' }}
        </p>
      </div>
      <div class="header-right">
        <div id="headerQRCode" class="header-qr"></div>
      </div>
    </header>

    <!-- Decorative Line -->
    <div class="header-line"></div>

    <!-- Patient Details Section -->
    <section class="patient-section">
      <div class="patient-grid">
        <div class="patient-row">
          <span class="label">ID</span>
          <span class="value">{{ registrationNo || '-' }}</span>
        </div>
        <div class="patient-row">
          <span class="label">Collection Date</span>
          <span class="value">{{ formatReportDate(pathologyRegDate) }}</span>
        </div>
        <div class="patient-row">
          <span class="label">Name</span>
          <span class="value patient-name">{{ formatName(patientName || patientData?.fullName || '') }}</span>
        </div>
        <div class="patient-row">
          <span class="label">Reporting Date</span>
          <span class="value">{{ formatReportDate(reportDate) }}</span>
        </div>
        <div class="patient-row">
          <span class="label">Age/Sex</span>
          <span class="value">{{ formatAgeWithUnit((age || patientData?.age), (reportData?.ageIn || patientData?.ageIn)) }} / {{ formatGender(gender || patientData?.gender) }}</span>
        </div>
        <div class="patient-row">
          <span class="label">Lab No.</span>
          <span class="value">{{ labYearlyNo || '' }}{{ labDailyNo ? '/' + labDailyNo : '' }}</span>
        </div>
        <div class="patient-row">
          <span class="label">Ref. By</span>
          <span class="value">{{ doctorName || 'Self' }}</span>
        </div>
        <div class="patient-row"></div>
      </div>
    </section>

    <!-- Test Results Section -->
    <section class="results-section">
      <!-- Debug: Always show data summary at top (remove after debugging) -->
      <div style="padding: 10px; background: #fffbe6; border: 1px solid #ffe58f; margin-bottom: 10px; font-size: 11px;">
        <strong>DEBUG:</strong> testResults={{ testResults.length }}, categoryGroups={{ categoryGroups.length }}
        <span *ngIf="testResults.length > 0">
          | First: {{ $any(testResults[0]).testName }} (params={{ $any(testResults[0]).parameters?.length || 0 }}, rows={{ $any(testResults[0]).displayRows?.length || 0 }})
        </span>
        <div *ngIf="testResults.length > 0" style="margin-top: 5px; padding: 5px; background: #fff; border: 1px dashed #ccc;">
          <strong>First Test Raw Data:</strong><br>
          <pre style="font-size: 9px; max-height: 150px; overflow: auto; white-space: pre-wrap;">{{ $any(testResults[0]) | json }}</pre>
        </div>
      </div>

      <!-- Show if no data -->
      <div class="no-data-msg" *ngIf="!categoryGroups || categoryGroups.length === 0" style="padding: 20px; text-align: center; color: #666; background: #f9f9f9; border-radius: 8px; margin: 10px 0;">
        <p style="margin: 0;">No test results to display</p>
        <small style="color: #999;">testResults: {{ testResults.length }} | categoryGroups: {{ categoryGroups.length }}</small>
      </div>

      <ng-container *ngFor="let group of categoryGroups">
        <!-- Category Header -->
        <div class="category-header">{{ group.category }}</div>

        <ng-container *ngFor="let testResult of group.tests">
          <!-- Test Name Row -->
          <div class="test-header">{{ testResult.testName }}</div>

          <!-- Results Table -->
          <table class="results-table">
            <thead>
              <tr>
                <th class="col-test">Test Name</th>
                <th class="col-result">Result</th>
                <th class="col-unit">Unit</th>
                <th class="col-range">Normal Value</th>
              </tr>
            </thead>
            <tbody>
              <!-- Use displayRows if available -->
              <ng-container *ngIf="testResult.displayRows && testResult.displayRows.length > 0">
                <ng-container *ngFor="let row of testResult.displayRows; let i = index">
                  <!-- Group Row -->
                  <tr class="group-row" *ngIf="row.kind === 'group' && hasGroupAnyValue(testResult.displayRows, i)">
                    <td colspan="4" class="group-name">{{ row.name }}</td>
                  </tr>
                  <!-- Parameter Row -->
                  <tr class="param-row" *ngIf="row.kind === 'param'"
                      [class.abnormal]="row.status === 'High' || row.status === 'Low' || row.status === 'Abnormal'">
                    <td class="col-test" [style.padding-left.px]="8 + (row.level || 0) * 16">{{ row.name }}</td>
                    <td class="col-result" [class.high]="row.status === 'High'" [class.low]="row.status === 'Low'">
                      {{ row.value }}
                    </td>
                    <td class="col-unit">{{ row.unit || '' }}</td>
                    <td class="col-range">
                      <ng-container *ngFor="let ln of splitRange(row.normalRange)">{{ ln }}<br></ng-container>
                    </td>
                  </tr>
                  <!-- Remark Row -->
                  <tr class="remark-row" *ngIf="row.kind === 'remark' && row.remarkText">
                    <td colspan="4" class="remark-text" [style.padding-left.px]="8 + (row.level || 0) * 16">{{ row.remarkText }}</td>
                  </tr>
                </ng-container>
              </ng-container>
              <!-- Fallback to parameters if displayRows is empty -->
              <ng-container *ngIf="!testResult.displayRows || testResult.displayRows.length === 0">
                <ng-container *ngFor="let param of (testResult.parameters || [])">
                  <tr class="param-row"
                      [class.abnormal]="$any(param).status === 'High' || $any(param).status === 'Low' || $any(param).status === 'Abnormal'">
                    <td class="col-test">{{ $any(param).name }}</td>
                    <td class="col-result" [class.high]="$any(param).status === 'High'" [class.low]="$any(param).status === 'Low'">
                      {{ $any(param).value || $any(param).result || '-' }}
                    </td>
                    <td class="col-unit">{{ $any(param).unit || '' }}</td>
                    <td class="col-range">
                      <ng-container *ngFor="let ln of splitRange($any(param).normalRange || $any(param).referenceRange)">{{ ln }}<br></ng-container>
                    </td>
                  </tr>
                </ng-container>
              </ng-container>
            </tbody>
          </table>
        </ng-container>
      </ng-container>
    </section>

    <!-- Footer Section -->
    <footer class="report-footer" *ngIf="labSettings?.printLayout?.showFooter !== false">
      <div class="footer-left">
        <!-- Empty or can add lab info -->
      </div>
      <div class="footer-right">
        <div class="signature-block">
          <img *ngIf="labSettings?.signatureDataUrl" [src]="labSettings?.signatureDataUrl" alt="Signature" class="signature-img">
          <div class="signature-line"></div>
          <span class="signatory-name">Authorized Signatory</span>
        </div>
      </div>
    </footer>

    <!-- Disclaimer -->
    <div class="disclaimer" *ngIf="labSettings?.footerNote || labSettings?.reportDisclaimer">
      <p *ngIf="labSettings?.footerNote">{{ labSettings?.footerNote }}</p>
      <p *ngIf="labSettings?.reportDisclaimer">{{ labSettings?.reportDisclaimer }}</p>
    </div>

  </div>
</div>