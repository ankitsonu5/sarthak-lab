<!-- Professional Diagnostic Report Layout -->
<div class="report-page">

  <!-- Print Controls (hidden in print) -->
  <div class="print-controls no-print">
    <button type="button" class="print-btn" (click)="printReport()">üñ®Ô∏è Print Report</button>
  </div>

  <!-- Main Report Container -->
  <div class="report-container" id="pathology-report-print">

    <!-- Header Section -->
    <header class="report-header" *ngIf="labSettings?.printLayout?.showHeader !== false">
      <div class="header-left">
        <img *ngIf="labSettings?.logoDataUrl" [src]="labSettings?.logoDataUrl" alt="Lab Logo" class="lab-logo">
      </div>
      <div class="header-center">
        <h1 class="lab-name">{{ defaultLabConfig.getLabName(labSettings?.labName) }}</h1>
        <p class="lab-tagline">Diagnostic & Pathology Services</p>
        <p class="lab-address" *ngIf="labSettings?.addressLine1 || labSettings?.city">
          {{ labSettings?.addressLine1 }}{{ labSettings?.addressLine2 ? ', ' + labSettings?.addressLine2 : '' }}{{ labSettings?.city ? ', ' + labSettings?.city : '' }}{{ labSettings?.state ? ', ' + labSettings?.state : '' }}{{ labSettings?.pincode ? ' - ' + labSettings?.pincode : '' }}
        </p>
        <p class="lab-contact" *ngIf="labSettings?.phone || labSettings?.email">
          {{ labSettings?.phone ? 'üìû ' + labSettings?.phone : '' }}{{ labSettings?.email ? ' | ‚úâ ' + labSettings?.email : '' }}
        </p>
      </div>
      <div class="header-right">
        <div id="headerQRCode" class="header-qr"></div>
      </div>
    </header>

    <!-- Decorative Line -->
    <div class="header-line"></div>

    <!-- Report Title -->
    <div class="report-title-bar">
      <span class="report-title">PATHOLOGY REPORT</span>
    </div>

    <!-- Patient Details Section -->
    <section class="patient-section">
      <div class="patient-grid">
        <div class="patient-row">
          <span class="label">Patient ID:</span>
          <span class="value">{{ registrationNo || '-' }}</span>
        </div>
        <div class="patient-row">
          <span class="label">Collection Date:</span>
          <span class="value">{{ formatReportDate(pathologyRegDate) }}</span>
        </div>
        <div class="patient-row">
          <span class="label">Patient Name:</span>
          <span class="value patient-name">{{ formatName(patientName || patientData?.fullName || '') }}</span>
        </div>
        <div class="patient-row">
          <span class="label">Report Date:</span>
          <span class="value">{{ formatReportDate(reportDate) }}</span>
        </div>
        <div class="patient-row">
          <span class="label">Age / Gender:</span>
          <span class="value">{{ formatAgeWithUnit((age || patientData?.age), (reportData?.ageIn || patientData?.ageIn)) }} / {{ formatGender(gender || patientData?.gender) }}</span>
        </div>
        <div class="patient-row">
          <span class="label">Lab No.:</span>
          <span class="value">{{ labYearlyNo || '' }}{{ labDailyNo ? '/' + labDailyNo : '' }}</span>
        </div>
        <div class="patient-row">
          <span class="label">Referred By:</span>
          <span class="value">{{ doctorName || 'Self' }}</span>
        </div>
        <!-- removed empty row to avoid extra separator/spacing -->
      </div>
    </section>

    <!-- Test Results Section -->
    <section class="results-section">
      <!-- Show if no data -->
      <div class="no-data-msg" *ngIf="!categoryGroups || categoryGroups.length === 0" style="padding: 20px; text-align: center; color: #666; background: #f9f9f9; border-radius: 8px; margin: 10px 0;">
        <p style="margin: 0;">No test results to display</p>
      </div>

      <ng-container *ngFor="let group of categoryGroups">
        <!-- Category Header -->
        <div class="category-header">{{ group.category }}</div>

        <ng-container *ngFor="let testResult of group.tests">
          <!-- Test Name Row -->
          <div class="test-header">{{ testResult.testName }}</div>

          <!-- Results Table -->
          <table class="results-table">
            <thead>
              <tr>
                <th class="col-test">Test Name</th>
                <th class="col-result">Result</th>
                <th class="col-unit">Unit</th>
                <th class="col-range">Normal Value</th>
              </tr>
            </thead>
            <tbody>
              <!-- Use displayRows if available -->
              <ng-container *ngIf="testResult.displayRows && testResult.displayRows.length > 0">
                <ng-container *ngFor="let row of testResult.displayRows; let i = index">
                  <!-- Group Row -->
                  <tr class="group-row" *ngIf="row.kind === 'group' && hasGroupAnyValue(testResult.displayRows, i)">
                    <td colspan="4" class="group-name">{{ row.name }}</td>
                  </tr>
                  <!-- Parameter Row -->
                  <tr class="param-row" *ngIf="row.kind === 'param'"
                      [class.abnormal]="row.status === 'High' || row.status === 'Low' || row.status === 'Abnormal'">
                    <td class="col-test" [style.padding-left.px]="8 + (row.level || 0) * 16">{{ row.name }}</td>
                    <td class="col-result" [class.high]="row.status === 'High'" [class.low]="row.status === 'Low'">
                      {{ row.value }}
                    </td>
                    <td class="col-unit">{{ row.unit || '' }}</td>
                    <td class="col-range">
                      <ng-container *ngFor="let ln of splitRange(row.normalRange)">{{ ln }}<br></ng-container>
                    </td>
                  </tr>
                  <!-- Remark Row -->
                  <tr class="remark-row" *ngIf="row.kind === 'remark' && row.remarkText">
                    <td colspan="4" class="remark-text" [style.padding-left.px]="8 + (row.level || 0) * 16">{{ row.remarkText }}</td>
                  </tr>
                </ng-container>
              </ng-container>
              <!-- Fallback to parameters if displayRows is empty -->
              <ng-container *ngIf="!testResult.displayRows || testResult.displayRows.length === 0">
                <ng-container *ngFor="let param of (testResult.parameters || [])">
                  <tr class="param-row"
                      [class.abnormal]="$any(param).status === 'High' || $any(param).status === 'Low' || $any(param).status === 'Abnormal'">
                    <td class="col-test">{{ $any(param).name }}</td>
                    <td class="col-result" [class.high]="$any(param).status === 'High'" [class.low]="$any(param).status === 'Low'">
                      {{ $any(param).value || $any(param).result || '-' }}
                    </td>
                    <td class="col-unit">{{ $any(param).unit || '' }}</td>
                    <td class="col-range">
                      <ng-container *ngFor="let ln of splitRange($any(param).normalRange || $any(param).referenceRange)">{{ ln }}<br></ng-container>
                    </td>
                  </tr>
                </ng-container>
              </ng-container>
            </tbody>
          </table>
        </ng-container>
      </ng-container>
    </section>

    <!-- Spacer to push footer down -->
    <div class="footer-spacer"></div>

    <!-- Footer Section - Fixed at Bottom -->
    <footer class="report-footer" *ngIf="labSettings?.printLayout?.showFooter !== false">
      <div class="footer-content">
        <div class="footer-left">
          <div class="verified-stamp">
            <span class="stamp-text">‚úì Electronically Verified</span>
          </div>
        </div>
        <div class="footer-center">
          <!-- Disclaimer moved here -->
          <div class="disclaimer-inline" *ngIf="labSettings?.footerNote || labSettings?.reportDisclaimer">
            <p *ngIf="labSettings?.footerNote">{{ labSettings?.footerNote }}</p>
            <p *ngIf="labSettings?.reportDisclaimer">{{ labSettings?.reportDisclaimer }}</p>
          </div>
        </div>
        <div class="footer-right">
          <div class="signature-block">
            <img *ngIf="labSettings?.signatureDataUrl" [src]="labSettings?.signatureDataUrl" alt="Signature" class="signature-img">
            <div class="signature-line"></div>
            <span class="signatory-name">Authorized Signatory</span>
            <span class="signatory-title">Pathologist</span>
          </div>
        </div>
      </div>
      <div class="footer-bottom-bar">
        <span>*** End of Report ***</span>
      </div>
    </footer>

  </div>
</div>